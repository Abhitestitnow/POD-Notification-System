<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>POD Release Notification System — Business Dashboard (Clean + Seamless)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ======================================================================
       Base variables and reset
       ====================================================================== */
    :root {
      --bg: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --chip: #f8fafc;
      --chip-active: #e0f2ff;
      --accent: #2563eb;
      --accent2: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
      --line-bg: #ffffff;
      --line-border: #e5e7eb;
      --shadow: 0 8px 24px rgba(0,0,0,0.06);
      --sky: #eaf4ff;
      --sky-border: #dbeafe;
      --panel: rgba(255,255,255,0.98);
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans", sans-serif; }

    /* ======================================================================
       Header bar
       ====================================================================== */
    header { position: sticky; top: 0; z-index: 60; background: #fff; border-bottom: 1px solid var(--border); padding: 12px 20px; }
    .bar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .title { font-weight: 800; font-size: 18px; letter-spacing: 0.2px; }
    .status { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .badge { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; background: #fff; }
    .inline-error { color: #9b1c1c; background: rgba(239,68,68,0.10); border: 1px solid #fecaca; border-radius: 8px; padding: 6px 10px; font-size: 12px; display: none; }
    #presentationBtn { border: 1px solid var(--border); background: transparent; color: var(--text); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 13px; }
    #presentationBtn:hover { transform: translateY(-1px); border-color: #cbd5e1; background: #eef2ff; }

    /* ======================================================================
       Strips: Pods and Weeks (sky-colored)
       ====================================================================== */
    .strip { width: 100%; background: var(--sky); border-top: 1px solid var(--sky-border); border-bottom: 1px solid var(--sky-border); }
    .container { max-width: 1240px; margin: 0 auto; padding: 8px 20px; }
    .row { display: flex; gap: 12px; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 10px 0; scroll-snap-type: x proximity; }
    .row::-webkit-scrollbar { height: 8px; }
    .row::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 8px; }
    .row::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }

    .chip { display: inline-flex; align-items: center; gap: 10px; padding: 14px 18px; border: 1px solid var(--border); border-radius: 999px; background: var(--chip); cursor: pointer; box-shadow: var(--shadow); transition: transform 0.08s ease, border-color 0.2s ease, background 0.2s ease; flex: 0 0 auto; scroll-snap-align: start; font-size: 14px; font-weight: 700; min-width: 130px; justify-content: center; }
    .chip:hover { transform: translateY(-1px); border-color: #cbd5e1; }
    .chip.active { background: var(--chip-active); border-color: #93c5fd; box-shadow: 0 0 0 2px rgba(37,99,235,0.12) inset; }
    .chip input { border: none; outline: none; background: transparent; color: var(--text); font-weight: 800; font-size: 14px; text-align: center; min-width: 120px; }
    .edit-icon { font-size: 14px; color: #9ca3af; cursor: pointer; user-select: none; }
    .edit-icon:hover { color: #374151; }

    /* ======================================================================
       Content panels (clean, minimal)
       ====================================================================== */
    .content { max-width: 1240px; margin: 0 auto; padding: 18px 20px 90px; }
    .panel { border: 1px solid var(--border); border-radius: 14px; background: var(--panel); box-shadow: var(--shadow); padding: 12px; }
    .panel h2 { margin: 0 0 8px; font-size: 16px; font-weight: 800; display: flex; align-items: center; justify-content: space-between; }
    .actions { display: flex; gap: 8px; align-items: center; }

    .btn { border: 1px solid var(--border); background: #f8fafc; color: var(--text); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 13px; transition: transform 0.08s ease, border-color 0.2s ease, background 0.2s ease; }
    .btn:hover { transform: translateY(-1px); border-color: #cbd5e1; background: #eef2ff; }
    .btn.primary { background: var(--accent); color: #fff; border-color: #1d4ed8; }
    .btn.green { background: var(--accent2); color: #fff; border-color: #15803d; }
    .btn.red { background: var(--danger); color: #fff; border-color: #b91c1c; }
    .btn.ghost { background: transparent; }

    /* Inline add forms (with pod dropdown + Other) */
    .inline-form { display: grid; grid-template-columns: 1.2fr 0.9fr 0.9fr 1.4fr auto; gap: 8px; align-items: center; margin: 6px 0 10px; }
    .inline-form input, .inline-form textarea, .inline-form select { padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; color: var(--text); font-size: 13px; }

    /* ======================================================================
       Minimal list rendering (no boxes; conditional fields)
       ====================================================================== */
    .lines { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .line { background: var(--line-bg); border: 1px solid var(--line-border); border-radius: 10px; padding: 10px 12px; display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: start; }
    .line:hover { background: #f9fafb; }
    .line-left { display: flex; flex-direction: column; gap: 4px; }
    .line-title-row { display: flex; flex-wrap: wrap; align-items: baseline; gap: 6px; }
    .line-index { font-weight: 800; color: var(--muted); }
    .line-title { font-weight: 800; }
    .line-meta { font-size: 12px; color: var(--muted); }
    .line-actions { display: inline-flex; gap: 6px; align-items: center; }
    .line-actions .btn { padding: 6px 10px; font-size: 12px; }
    .empty { font-size: 12px; color: var(--muted); border: 1px dashed var(--border); border-radius: 8px; padding: 8px; background: #fff; text-align: center; }

    /* ======================================================================
       Body layout: Previous on top; Next same size (left); Blockers right
       ====================================================================== */
    .stack { display: flex; flex-direction: column; gap: 16px; }
    .row-two { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 1080px) { .row-two { grid-template-columns: 1fr; } }

    /* ======================================================================
       Bottom bar: theme gear + save all
       ====================================================================== */
    .bar-bottom { position: fixed; left: 16px; right: 16px; bottom: 16px; display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px solid var(--border); border-radius: 12px; background: #fff; box-shadow: var(--shadow); padding: 8px 12px; z-index: 70; }
    .left-controls { display: flex; align-items: center; gap: 10px; }
    .theme-gear { width: 30px; height: 30px; border: 1px solid var(--border); border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; background: #f8fafc; color: var(--muted); cursor: pointer; user-select: none; }
    .theme-gear:hover { background: #eef2ff; color: var(--text); }
    .theme-menu { position: absolute; left: 16px; bottom: 60px; display: none; flex-wrap: wrap; gap: 8px; background: #fff; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); padding: 10px; z-index: 80; }
    .theme-dot { width: 22px; height: 22px; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; }

    /* ======================================================================
       Presentation mode (clean)
       ====================================================================== */
    body.presentation { background: #fff; color: #0f172a; }
    body.presentation .inline-form,
    body.presentation .line-actions,
    body.presentation .btn,
    body.presentation .theme-gear,
    body.presentation .theme-menu { display: none !important; }
    body.presentation .panel,
    body.presentation .line { box-shadow: none; background: #fff; border-color: #e5e7eb; }

    /* ======================================================================
       Themes (persisted)
       ====================================================================== */
    .theme-sky     { --accent:#3b82f6; --accent2:#22c55e; }
    .theme-ocean   { --accent:#38bdf8; --accent2:#34d399; }
    .theme-forest  { --accent:#22c55e; --accent2:#65a30d; }
    .theme-rose    { --accent:#f472b6; --accent2:#fb7185; }
    .theme-sunset  { --accent:#fb923c; --accent2:#f59e0b; }
    .theme-violet  { --accent:#8b5cf6; --accent2:#22c55e; }
    .theme-carbon  { --accent:#111827; --accent2:#22c55e; }
    .theme-mint    { --accent:#2dd4bf; --accent2:#22c55e; }
    .theme-gold    { --accent:#f59e0b; --accent2:#22c55e; }
  </style>
</head>
<body class="theme-sky">
  <!-- ====================================================================
       Top bar
       ==================================================================== -->
  <header>
    <div class="bar">
      <div class="title">POD Release Notification System</div>
      <div class="status">
        <span id="authState" class="badge">Auth: …</span>
        <span id="globalError" class="inline-error"></span>
        <button id="presentationBtn" title="Presentation mode">Presentation mode</button>
      </div>
    </div>
  </header>

  <!-- ====================================================================
       Pods strip
       ==================================================================== -->
  <div class="strip">
    <div class="container">
      <div class="row" id="podsRow"></div>
    </div>
  </div>

  <!-- ====================================================================
       Weeks strip
       ==================================================================== -->
  <div class="strip">
    <div class="container">
      <div class="row" id="weeksRow"></div>
    </div>
  </div>

  <!-- ====================================================================
       Content: previous on top (full row); next (left) + blockers (right) same size
       ==================================================================== -->
  <div class="content">
    <div class="stack">
      <!-- Previous release -->
      <div class="panel">
        <h2>
          <span>Previous release</span>
          <div class="actions">
            <button class="btn" id="toggleLastForm">+ Add</button>
          </div>
        </h2>
        <div class="inline-form" id="lastForm" style="display:none">
          <input id="lastTitle" placeholder="Title (e.g., Build SR Onboarding)" />
          <input id="lastDate" type="date" />
          <select id="lastPod"></select>
          <textarea id="lastNotes" placeholder="Comments (optional)"></textarea>
          <button class="btn green" id="addLast">Save</button>
        </div>
        <div class="lines" id="lastList"><div class="empty">No previous releases yet.</div></div>
      </div>

      <!-- Next + Blockers row -->
      <div class="row-two">
        <div class="panel">
          <h2>
            <span>Next release</span>
            <div class="actions">
              <button class="btn" id="toggleUpcomingForm">+ Add</button>
            </div>
          </h2>
          <div class="inline-form" id="upForm" style="display:none">
            <input id="upTitle" placeholder="Title (e.g., SLA Alerts 2.0)" />
            <input id="upDate" type="date" />
            <select id="upPod"></select>
            <textarea id="upNotes" placeholder="Comments (optional)"></textarea>
            <button class="btn green" id="addUpcoming">Save</button>
          </div>
          <div class="lines" id="upList"><div class="empty">No upcoming releases yet.</div></div>
        </div>

        <div class="panel">
          <h2>
            <span>Blockers</span>
            <div class="actions">
              <button class="btn red" id="toggleBlockerForm">+ Add</button>
            </div>
          </h2>
          <div class="inline-form" id="blockForm" style="display:none; grid-template-columns:1.2fr 0.9fr 0.9fr 1.4fr auto">
            <input id="blockTitle" placeholder="Summary (e.g., API dependency delay)" />
            <input id="blockOwner" placeholder="Owner / Team (optional)" />
            <select id="blockPod"></select>
            <textarea id="blockNotes" placeholder="Details (optional)"></textarea>
            <button class="btn red" id="addBlocker">Save</button>
          </div>
          <div class="lines" id="blockList"><div class="empty">No blockers yet.</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====================================================================
       Bottom bar: theme gear + central save
       ==================================================================== -->
  <div class="bar-bottom">
    <div class="left-controls">
      <div id="themeGear" class="theme-gear" title="Theme">⚙</div>
      <div id="themeMenu" class="theme-menu">
        <div class="theme-dot" data-theme="theme-sky"    style="background:#0ea5e9" title="Sky"></div>
        <div class="theme-dot" data-theme="theme-ocean"  style="background:#38bdf8" title="Ocean"></div>
        <div class="theme-dot" data-theme="theme-forest" style="background:#22c55e" title="Forest"></div>
        <div class="theme-dot" data-theme="theme-rose"   style="background:#f472b6" title="Rose"></div>
        <div class="theme-dot" data-theme="theme-sunset" style="background:#fb923c" title="Sunset"></div>
        <div class="theme-dot" data-theme="theme-violet" style="background:#8b5cf6" title="Violet"></div>
        <div class="theme-dot" data-theme="theme-carbon" style="background:#111827" title="Carbon"></div>
        <div class="theme-dot" data-theme="theme-mint"   style="background:#2dd4bf" title="Mint"></div>
        <div class="theme-dot" data-theme="theme-gold"   style="background:#f59e0b" title="Gold"></div>
      </div>
    </div>
    <div><button id="saveAll" class="btn primary" title="Save all visible edits and pod names">Save all</button></div>
  </div>

  <!-- ====================================================================
       Scripts: Firebase + App
       ==================================================================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, addDoc, query, where, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ---------------------------------------------------------
       Firebase config
       --------------------------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBZd-UtIKqRfe_rcCH02XZuYmPnCTMDRDY",
      authDomain: "notification-system-pod.firebaseapp.com",
      projectId: "notification-system-pod",
      storageBucket: "notification-system-pod.firebasestorage.app",
      messagingSenderId: "975892643280",
      appId: "1:975892643280:web:fb0898d60c37e4a749cdd5",
      measurementId: "G-JZSPSEVCN1"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let db = null;

    /* ---------------------------------------------------------
       DOM helpers
       --------------------------------------------------------- */
    const el = id => document.getElementById(id);
    const podsRow = el("podsRow");
    const weeksRow = el("weeksRow");
    const authStateEl = el("authState");
    const globalError = el("globalError");
    const lastForm = el("lastForm"), upForm = el("upForm"), blockForm = el("blockForm");
    const lastList = el("lastList"), upList = el("upList"), blockList = el("blockList");
    const themeGear = el("themeGear"), themeMenu = el("themeMenu");
    const lastPodSel = el("lastPod"), upPodSel = el("upPod"), blockPodSel = el("blockPod");

    /* ---------------------------------------------------------
       State
       --------------------------------------------------------- */
    // Pods include ALL and OTHERS; OTHERS only shows under ALL and "Others" filter, not as a renameable regular pod
    let pods = ["ALL","D&S","SLA","LOSS","CX","HYC","Others"];
    let activePod = "ALL";
    let activeWeekKey = "", activeWeekLabel = "", previousWeekKey = "";
    let unsubLast = null, unsubUpcoming = null, unsubBlockers = null;

    /* ---------------------------------------------------------
       Error helpers
       --------------------------------------------------------- */
    function showError(msg) { globalError.textContent = msg; globalError.style.display = "inline-block"; }
    function clearError() { globalError.textContent = ""; globalError.style.display = "none"; }

    /* ---------------------------------------------------------
       Meta doc for pods
       --------------------------------------------------------- */
    const podsDoc = () => doc(db, "dashboard_meta", "pods");

    async function loadPodsFromDb() {
      try {
        const snap = await getDoc(podsDoc());
        if (snap.exists()) {
          const p = snap.data().pods;
          if (Array.isArray(p) && p.length >= 7 && p[0] === "ALL" && p[p.length-1] === "Others") {
            pods = p;
            if (!pods.includes(activePod)) activePod = "ALL";
          }
        }
      } catch (e) {
        showError("Failed to load pods. " + e.message);
      }
    }
    async function savePodsToDb() {
      try {
        await setDoc(podsDoc(), { pods, updatedAt: serverTimestamp() }, { merge: true });
      } catch (e) {
        showError("Failed to save pod names. " + e.message);
      }
    }

    /* ---------------------------------------------------------
       Week helpers
       --------------------------------------------------------- */
    function weekInfo(date = new Date()) {
      const d = new Date(date.getTime());
      const dayNum = (d.getDay() + 6) % 7; d.setDate(d.getDate() - dayNum + 3);
      const firstThursday = new Date(d.getFullYear(), 0, 4);
      const firstDayNum = (firstThursday.getDay() + 6) % 7;
      firstThursday.setDate(firstThursday.getDate() - firstDayNum + 3);
      const isoWeek = 1 + Math.round((d.getTime() - firstThursday.getTime()) / 604800000);

      const now = new Date(date);
      const year = d.getFullYear();
      const month = now.getMonth();
      const firstOfMonth = new Date(year, month, 1);
      const shift = (firstOfMonth.getDay() + 6) % 7;
      const weekOfMonth = Math.floor((now.getDate() + shift - 1) / 7) + 1;
      const quarter = Math.floor(month / 3) + 1;
      const label = `Week ${weekOfMonth} - Q${quarter} - ${year}`;

      const monday = new Date(now.getTime());
      monday.setDate(monday.getDate() - ((monday.getDay() + 6) % 7));
      const prevMon = new Date(monday.getTime());
      prevMon.setDate(prevMon.getDate() - 7);
      const prevKey = weekInfoPlain(prevMon);

      return { key: `${year}-W${String(isoWeek).padStart(2, "0")}`, label, prevKey };
    }
    function weekInfoPlain(date) {
      const d = new Date(date.getTime());
      const dayNum = (d.getDay() + 6) % 7; d.setDate(d.getDate() - dayNum + 3);
      const firstThursday = new Date(d.getFullYear(), 0, 4);
      const firstDayNum = (firstThursday.getDay() + 6) % 7;
      firstThursday.setDate(firstThursday.getDate() - firstDayNum + 3);
      const isoWeek = 1 + Math.round((d.getTime() - firstThursday.getTime()) / 604800000);
      return `${d.getFullYear()}-W${String(isoWeek).padStart(2, "0")}`;
    }

    /* ---------------------------------------------------------
       Populate pod dropdowns (exclude ALL; include Others)
       --------------------------------------------------------- */
    function populatePodDropdowns() {
      const options = pods.filter(p => p !== "ALL");
      function fill(selectEl) {
        selectEl.innerHTML = "";
        options.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p; opt.textContent = p; selectEl.appendChild(opt);
        });
        // Default to active pod if not ALL, else "Others"
        if (activePod !== "ALL" && options.includes(activePod)) selectEl.value = activePod;
        else if (options.includes("Others")) selectEl.value = "Others";
        else if (options.length) selectEl.value = options[0];
      }
      fill(lastPodSel); fill(upPodSel); fill(blockPodSel);
    }

    /* ---------------------------------------------------------
       Minimal list item builders (conditional display)
       --------------------------------------------------------- */
    function lineItem(index, id, data, colName) {
      const li = document.createElement("div");
      li.className = "line";
      li.dataset.id = id;
      li.dataset.col = colName;

      const left = document.createElement("div");
      left.className = "line-left";

      // Title row: "1/ Title (pod)" — omit (pod) if pod missing
      const titleRow = document.createElement("div");
      titleRow.className = "line-title-row";
      const idx = document.createElement("span");
      idx.className = "line-index";
      idx.textContent = `${index}/`;
      const title = document.createElement("span");
      title.className = "line-title";
      title.contentEditable = "true";
      title.textContent = data.title || "";
      titleRow.appendChild(idx);
      titleRow.appendChild(title);
      if (data.pod) {
        const podLabel = document.createElement("span");
        podLabel.className = "line-meta";
        podLabel.textContent = `(${data.pod})`;
        titleRow.appendChild(podLabel);
      }
      left.appendChild(titleRow);

      // Date row — only if date present
      if (data.date) {
        const dateRow = document.createElement("div");
        const dateLabel = document.createElement("span");
        dateLabel.className = "line-meta";
        dateLabel.textContent = "Release date:";
        const dateVal = document.createElement("input");
        dateVal.type = "date";
        dateVal.value = data.date || "";
        dateVal.style.border = "1px solid var(--border)";
        dateVal.style.borderRadius = "6px";
        dateVal.style.padding = "4px 6px";
        dateVal.style.fontSize = "12px";
        dateRow.appendChild(dateLabel);
        dateRow.appendChild(dateVal);
        left.appendChild(dateRow);
      }

      // Notes row — only if notes present
      if (data.notes) {
        const notesRow = document.createElement("div");
        const notesLabel = document.createElement("span");
        notesLabel.className = "line-meta";
        notesLabel.textContent = "Comment:";
        const notesVal = document.createElement("textarea");
        notesVal.value = data.notes || "";
        notesVal.style.border = "1px solid var(--border)";
        notesVal.style.borderRadius = "6px";
        notesVal.style.padding = "6px";
        notesVal.style.fontSize = "12px";
        notesVal.style.minHeight = "46px";
        notesVal.style.width = "100%";
        notesRow.appendChild(notesLabel);
        notesRow.appendChild(notesVal);
        left.appendChild(notesRow);
      }

      const right = document.createElement("div");
      right.className = "line-actions";
      const save = document.createElement("button");
      save.className = "btn";
      save.textContent = "Save";
      const del = document.createElement("button");
      del.className = "btn red";
      del.textContent = "Delete";
      right.appendChild(save);
      right.appendChild(del);

      li.appendChild(left);
      li.appendChild(right);

      save.onclick = async () => {
        if (!db) { showError("Auth failed. Enable Anonymous sign-in and add your domain."); return; }
        // Collect editable fields if they exist
        const payload = { updatedAt: serverTimestamp() };
        payload.title = title.textContent.trim();
        const dateEl = li.querySelector('input[type="date"]');
        if (dateEl) payload.date = dateEl.value || null;
        const notesEl = li.querySelector('textarea');
        if (notesEl) payload.notes = notesEl.value.trim() || null;
        try { await updateDoc(doc(db, colName, id), payload); }
        catch(e){ showError("Save failed. " + e.message); }
      };
      del.onclick = async () => {
        if (!db) { showError("Auth failed. Enable Anonymous sign-in and add your domain."); return; }
        try { await deleteDoc(doc(db, colName, id)); }
        catch(e){ showError("Delete failed. " + e.message); }
      };

      return li;
    }

    function blockerLineItem(index, id, data, colName) {
      const li = document.createElement("div");
      li.className = "line";
      li.dataset.id = id;
      li.dataset.col = colName;

      const left = document.createElement("div");
      left.className = "line-left";

      const titleRow = document.createElement("div");
      titleRow.className = "line-title-row";
      const idx = document.createElement("span");
      idx.className = "line-index";
      idx.textContent = `${index}/`;
      const title = document.createElement("span");
      title.className = "line-title";
      title.contentEditable = "true";
      title.textContent = data.title || "";
      titleRow.appendChild(idx);
      titleRow.appendChild(title);
      // Conditional owner and pod
      const metaParts = [];
      if (data.owner) metaParts.push(`Owner: ${data.owner}`);
      if (data.pod) metaParts.push(`Pod: ${data.pod}`);
      if (metaParts.length) {
        const ownerPod = document.createElement("span");
        ownerPod.className = "line-meta";
        ownerPod.textContent = `(${metaParts.join(", ")})`;
        titleRow.appendChild(ownerPod);
      }
      left.appendChild(titleRow);

      // Severity if present
      if (data.severity) {
        const sevRow = document.createElement("div");
        const sevLabel = document.createElement("span");
        sevLabel.className = "line-meta";
        sevLabel.textContent = "Severity:";
        const sevVal = document.createElement("input");
        sevVal.value = data.severity || "Medium";
        sevVal.style.border = "1px solid var(--border)";
        sevVal.style.borderRadius = "6px";
        sevVal.style.padding = "4px 6px";
        sevVal.style.fontSize = "12px";
        sevRow.appendChild(sevLabel);
        sevRow.appendChild(sevVal);
        left.appendChild(sevRow);
      }

      // Notes if present
      if (data.notes) {
        const notesRow = document.createElement("div");
        const notesLabel = document.createElement("span");
        notesLabel.className = "line-meta";
        notesLabel.textContent = "Details:";
        const notesVal = document.createElement("textarea");
        notesVal.value = data.notes || "";
        notesVal.style.border = "1px solid var(--border)";
        notesVal.style.borderRadius = "6px";
        notesVal.style.padding = "6px";
        notesVal.style.fontSize = "12px";
        notesVal.style.minHeight = "46px";
        notesVal.style.width = "100%";
        notesRow.appendChild(notesLabel);
        notesRow.appendChild(notesVal);
        left.appendChild(notesRow);
      }

      const right = document.createElement("div");
      right.className = "line-actions";
      const save = document.createElement("button");
      save.className = "btn";
      save.textContent = "Save";
      const del = document.createElement("button");
      del.className = "btn red";
      del.textContent = "Delete";
      right.appendChild(save);
      right.appendChild(del);

      li.appendChild(left);
      li.appendChild(right);

      save.onclick = async () => {
        if (!db) { showError("Auth failed. Enable Anonymous sign-in and add your domain."); return; }
        const payload = { updatedAt: serverTimestamp() };
        payload.title = title.textContent.trim();
        const sevEl = li.querySelector('input:not([type="date"])');
        if (sevEl) payload.severity = sevEl.value.trim() || null;
        const notesEl = li.querySelector('textarea');
        if (notesEl) payload.notes = notesEl.value.trim() || null;
        try { await updateDoc(doc(db, colName, id), payload); }
        catch(e){ showError("Save failed. " + e.message); }
      };
      del.onclick = async () => {
        if (!db) { showError("Auth failed. Enable Anonymous sign-in and add your domain."); return; }
        try { await deleteDoc(doc(db, colName, id)); }
        catch(e){ showError("Delete failed. " + e.message); }
      };

      return li;
    }

    /* ---------------------------------------------------------
       Optimistic rendering helper
       --------------------------------------------------------- */
    function optimisticPrepend(listEl, builder, tempId, payload, colName) {
      const currentCount = Array.from(listEl.children).filter(c => c.classList.contains("line")).length;
      const node = builder(currentCount + 1, tempId, payload, colName);
      node.style.opacity = "0.75";
      node.style.outline = "1px dashed var(--border)";
      listEl.querySelector(".empty")?.remove();
      listEl.prepend(node);
      return node;
    }

    /* ---------------------------------------------------------
       Pods line (chips, inline rename)
       - Keep "ALL" at start and "Others" at end (non-renamable)
       --------------------------------------------------------- */
    function renderPodsLine() {
      podsRow.innerHTML = "";
      pods.forEach((p, i) => {
        const chip = document.createElement("div");
        chip.className = "chip" + (p === activePod ? " active" : "");
        chip.title = p;
        const label = document.createElement("span"); label.textContent = p;
        chip.appendChild(label);

        chip.onclick = () => {
          activePod = p;
          renderPodsLine();
          rebindRealtime();
          populatePodDropdowns();
        };

        // Inline rename: allowed for middle pods only (not ALL, not Others)
        chip.ondblclick = () => {
          if (i === 0 || p === "Others") { alert(`${p} cannot be renamed.`); return; }
          const input = document.createElement("input");
          input.value = p;
          chip.innerHTML = "";
          chip.appendChild(input);
          input.focus();
          input.onblur = () => {
            const newName = input.value.trim();
            chip.innerHTML = "";
            chip.appendChild(label);
            if (!newName) return;
            pods[i] = newName;
            label.textContent = newName;
            populatePodDropdowns();
          };
          input.onkeydown = (e) => {
            if (e.key === "Enter") input.blur();
            if (e.key === "Escape") { chip.innerHTML = ""; chip.appendChild(label); }
          };
        };

        podsRow.appendChild(chip);
      });

      const editChip = document.createElement("div");
      editChip.className = "chip";
      editChip.innerHTML = `<span class="edit-icon" title="Rename pods">✏️ Edit pods</span>`;
      editChip.onclick = () => {
        const oldName = prompt("Pod to rename (D&S, SLA, LOSS, CX, HYC):", "D&S");
        if (!oldName) return;
        if (oldName.toUpperCase() === "ALL" || oldName === "Others") { alert(`${oldName} cannot be renamed.`); return; }
        const idx = pods.findIndex(x => x.toLowerCase() === oldName.toLowerCase());
        if (idx === -1) { alert("Pod not found."); return; }
        const newName = prompt(`New name for ${oldName}:`, oldName);
        if (!newName || !newName.trim()) return;
        pods[idx] = newName.trim();
        if (activePod.toLowerCase() === oldName.toLowerCase()) activePod = pods[idx];
        renderPodsLine(); rebindRealtime(); populatePodDropdowns();
      };
      podsRow.appendChild(editChip);
    }

    /* ---------------------------------------------------------
       Weeks line
       --------------------------------------------------------- */
    function renderWeeksLine() {
      weeksRow.innerHTML = "";
      const nowInfo = weekInfo(new Date());
      activeWeekKey = activeWeekKey || nowInfo.key;
      activeWeekLabel = activeWeekLabel || nowInfo.label;
      previousWeekKey = nowInfo.prevKey;

      const entries = [];
      const baseMonday = new Date();
      baseMonday.setDate(baseMonday.getDate() - ((baseMonday.getDay() + 6) % 7));
      for (let i = 0; i < 5; i++) {
        const d = new Date(baseMonday.getTime());
        d.setDate(d.getDate() - (7 * i));
        const info = weekInfo(d);
        if (info.key === activeWeekKey) info.label = activeWeekLabel;
        entries.push(info);
      }

      entries.forEach(info => {
        const chip = document.createElement("div");
        chip.className = "chip" + (info.key === activeWeekKey ? " active" : "");
        chip.title = info.key;
        const input = document.createElement("input");
        input.value = info.label;
        input.readOnly = true;
        chip.appendChild(input);
        chip.onclick = () => {
          activeWeekKey = info.key;
          activeWeekLabel = info.label;
          previousWeekKey = info.prevKey;
          renderWeeksLine();
          rebindRealtime();
        };
        weeksRow.appendChild(chip);
      });

      const editChip = document.createElement("div");
      editChip.className = "chip";
      editChip.innerHTML = `<span class="edit-icon" title="Edit active week label">✏️ Edit week</span>`;
      editChip.onclick = () => {
        const newLabel = prompt("Week label (Week X - QY - YYYY):", activeWeekLabel);
        if (!newLabel || !newLabel.trim()) return;
        activeWeekLabel = newLabel.trim();
        renderWeeksLine();
      };
      weeksRow.appendChild(editChip);
    }

    /* ---------------------------------------------------------
       Auth
       --------------------------------------------------------- */
    async function initAuth() {
      try {
        await signInAnonymously(auth);
        db = getFirestore(app);
        authStateEl.textContent = "Auth: Anonymous";
        clearError();
        await loadPodsFromDb();
        renderPodsLine();
        populatePodDropdowns();
      } catch (e) {
        try { db = getFirestore(app); } catch (_) {}
        authStateEl.textContent = "Auth: Failed";
        showError("Enable Anonymous sign-in and add your domain in Firebase.");
      }
    }

    /* ---------------------------------------------------------
       Collections
       --------------------------------------------------------- */
    const lastCol  = () => collection(db, "dashboard_last");
    const upCol    = () => collection(db, "dashboard_upcoming");
    const blockCol = () => collection(db, "dashboard_blockers");

    /* ---------------------------------------------------------
       Add handlers (pod dropdown + active week) with optimistic render
       --------------------------------------------------------- */
    async function addLastItem() {
      const title = el("lastTitle").value.trim();
      const date = el("lastDate").value;
      const notes = el("lastNotes").value.trim();
      const podSel = el("lastPod").value;
      if (!title || !date) { alert("Provide Title and Release Date"); return; }
      if (!db) { showError("Auth failed. Enable Anonymous sign-in and add your domain."); return; }

      const payload = { pod: podSel, weekKey: activeWeekKey, weekKeyLabel: activeWeekLabel, title, date, notes: notes || null, createdAt: new Date() };
      const tempId = "temp_last_" + Math.random().toString(36).slice(2);
      const tempNode = optimisticPrepend(lastList, lineItem, tempId, payload, "dashboard_last");

      try {
        await addDoc(lastCol(), {
          pod: podSel,
          weekKey: activeWeekKey,
          weekKeyLabel: activeWeekLabel,
          title, date, notes: notes || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        tempNode.remove(); // snapshot will add the real item
      } catch (e) {
        showError("Failed to add previous release. " + e.message);
      }

      el("lastTitle").value = ""; el("lastDate").value = ""; el("lastNotes").value = "";
      lastForm.style.display = "none";
    }

    async function addUpcomingItem() {
      const title = el("upTitle").value.trim();
      const date = el("upDate").value;
      const notes = el("upNotes").value.trim();
      const podSel = el("upPod").value;
      if (!title || !date) { alert("Provide Title and Release Date"); return; }
      if (!db) { showError("Auth failed. Enable Anonymous sign-in and add your domain."); return; }

      const payload = { pod: podSel, weekKey: activeWeekKey, weekKeyLabel: activeWeekLabel, title, date, notes: notes || null, createdAt: new Date() };
      const tempId = "temp_up_" + Math.random().toString(36).slice(2);
      const tempNode = optimisticPrepend(upList, lineItem, tempId, payload, "dashboard_upcoming");

      try {
        await addDoc(upCol(), {
          pod: podSel,
          weekKey: activeWeekKey,
          weekKeyLabel: activeWeekLabel,
          title, date, notes: notes || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        tempNode.remove();
      } catch (e) {
        showError("Failed to add upcoming release. " + e.message);
      }

      el("upTitle").value = ""; el("upDate").value = ""; el("upNotes").value = "";
      upForm.style.display = "none";
    }

    async function addBlockerItem() {
      const title = el("blockTitle").value.trim();
      const owner = el("blockOwner").value.trim();
      const notes = el("blockNotes").value.trim();
      const podSel = el("blockPod").value;
      if (!title) { alert("Provide Blocker Summary"); return; }
      if (!db) { showError("Auth failed. Enable Anonymous sign-in and add your domain."); return; }

      const payload = {
        pod: podSel, weekKey: activeWeekKey, weekKeyLabel: activeWeekLabel,
        title, owner: owner || null, notes: notes || null, severity: "Medium", createdAt: new Date()
      };
      const tempId = "temp_block_" + Math.random().toString(36).slice(2);
      const tempNode = optimisticPrepend(blockList, blockerLineItem, tempId, payload, "dashboard_blockers");

      try {
        await addDoc(blockCol(), {
          pod: podSel,
          weekKey: activeWeekKey,
          weekKeyLabel: activeWeekLabel,
          title, owner: owner || null, notes: notes || null, severity: "Medium",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        tempNode.remove();
      } catch (e) {
        showError("Failed to add blocker. " + e.message);
      }

      el("blockTitle").value = ""; el("blockOwner").value = ""; el("blockNotes").value = "";
      blockForm.style.display = "none";
    }

    /* ---------------------------------------------------------
       Realtime bindings (ALL aggregates by week; pod filters by pod+week)
       - "Others" is treated as its own pod for filtering
       --------------------------------------------------------- */
    function rebindRealtime() {
      if (!db) return;

      try { unsubLast && unsubLast(); } catch(_) {}
      try { unsubUpcoming && unsubUpcoming(); } catch(_) {}
      try { unsubBlockers && unsubBlockers(); } catch(_) {}

      const isAll = activePod === "ALL";

      // Previous releases
      try {
        const qLast = isAll
          ? query(lastCol(), where("weekKey", "==", activeWeekKey))
          : query(lastCol(), where("pod", "==", activePod), where("weekKey", "==", activeWeekKey));
        unsubLast = onSnapshot(qLast, (snap) => {
          lastList.innerHTML = "";
          if (snap.empty) { lastList.innerHTML = `<div class="empty">No previous releases</div>`; return; }
          const items = [];
          snap.forEach(d => items.push({ id: d.id, data: d.data() }));
          // latest first
          items.sort((a,b)=> (b.data.createdAt?.seconds || 0) - (a.data.createdAt?.seconds || 0));
          let idx = 1;
          items.forEach(({id,data}) => lastList.appendChild(lineItem(idx++, id, data, "dashboard_last")));
        }, (err)=> showError("Previous releases listener error: " + err.message));
      } catch(e){ showError("Previous releases query error: " + e.message); }

      // Upcoming releases
      try {
        const qUp = isAll
          ? query(upCol(), where("weekKey", "==", activeWeekKey))
          : query(upCol(), where("pod", "==", activePod), where("weekKey", "==", activeWeekKey));
        unsubUpcoming = onSnapshot(qUp, (snap) => {
          upList.innerHTML = "";
          if (snap.empty) { upList.innerHTML = `<div class="empty">No upcoming releases</div>`; return; }
          const items = [];
          snap.forEach(d => items.push({ id: d.id, data: d.data() }));
          items.sort((a,b)=> (b.data.createdAt?.seconds || 0) - (a.data.createdAt?.seconds || 0));
          let idx = 1;
          items.forEach(({id,data}) => upList.appendChild(lineItem(idx++, id, data, "dashboard_upcoming")));
        }, (err)=> showError("Upcoming listener error: " + err.message));
      } catch(e){ showError("Upcoming query error: " + e.message); }

      // Blockers
      try {
        const qBlock = isAll
          ? query(blockCol(), where("weekKey", "==", activeWeekKey))
          : query(blockCol(), where("pod", "==", activePod), where("weekKey", "==", activeWeekKey));
        unsubBlockers = onSnapshot(qBlock, (snap) => {
          blockList.innerHTML = "";
          if (snap.empty) { blockList.innerHTML = `<div class="empty">No blockers</div>`; return; }
          const items = [];
          snap.forEach(d => items.push({ id: d.id, data: d.data() }));
          items.sort((a,b)=> (b.data.createdAt?.seconds || 0) - (a.data.createdAt?.seconds || 0));
          let idx = 1;
          items.forEach(({id,data}) => blockList.appendChild(blockerLineItem(idx++, id, data, "dashboard_blockers")));
        }, (err)=> showError("Blockers listener error: " + err.message));
      } catch(e){ showError("Blockers query error: " + e.message); }
    }

    /* ---------------------------------------------------------
       Central Save (pods + visible edits)
       --------------------------------------------------------- */
    async function saveAll() {
      if (!db) { showError("Auth failed. Enable Anonymous sign-in and add your domain."); return; }
      const tasks = [];
      tasks.push(savePodsToDb());

      document.querySelectorAll(".line").forEach(node => {
        const id = node.dataset.id, col = node.dataset.col;
        if (!id || !col) return;
        const payload = { updatedAt: serverTimestamp() };
        const titleEl = node.querySelector(".line-title"); if (titleEl) payload.title = titleEl.textContent.trim();
        const dateEl = node.querySelector('input[type="date"]'); payload.date = dateEl ? (dateEl.value || null) : null;
        const notesEl = node.querySelector('textarea'); payload.notes = notesEl ? (notesEl.value.trim() || null) : null;
        const sevEl = node.querySelector('input:not([type="date"])');
        if (sevEl && col === "dashboard_blockers") payload.severity = sevEl.value.trim() || null;
        tasks.push(updateDoc(doc(db, col, id), payload));
      });

      try { await Promise.all(tasks); clearError(); alert("All edits saved."); }
      catch(e){ showError("Failed to save some items. " + e.message); }
    }

    /* ---------------------------------------------------------
       Theme gear + palette (persisted)
       --------------------------------------------------------- */
    function bindThemes() {
      let open = false;
      themeGear.onclick = () => { open = !open; themeMenu.style.display = open ? "flex" : "none"; };
      document.querySelectorAll(".theme-dot").forEach(dot => {
        dot.onclick = () => {
          const theme = dot.dataset.theme || "theme-sky";
          document.body.className = theme;
          localStorage.setItem("pod_theme", theme);
          themeMenu.style.display = "none";
          open = false;
        };
      });
      const saved = localStorage.getItem("pod_theme"); if (saved) document.body.className = saved;
      document.addEventListener("click", (e) => {
        const inside = e.target.closest("#themeMenu") || e.target.closest("#themeGear");
        if (!inside) { themeMenu.style.display = "none"; open = false; }
      });
    }

    /* ---------------------------------------------------------
       Presentation mode (ESC to exit)
       --------------------------------------------------------- */
    function bindPresentationMode() {
      el("presentationBtn").onclick = () => { document.body.classList.add("presentation"); };
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") document.body.classList.remove("presentation"); });
    }

    /* ---------------------------------------------------------
       UI bindings
       --------------------------------------------------------- */
    function bindUI() {
      el("toggleLastForm").onclick = () => { lastForm.style.display = lastForm.style.display === "none" ? "grid" : "none"; };
      el("toggleUpcomingForm").onclick = () => { upForm.style.display = upForm.style.display === "none" ? "grid" : "none"; };
      el("toggleBlockerForm").onclick = () => { blockForm.style.display = blockForm.style.display === "none" ? "grid" : "none"; };

      el("addLast").onclick = addLastItem;
      el("addUpcoming").onclick = addUpcomingItem;
      el("addBlocker").onclick = addBlockerItem;

      el("saveAll").onclick = saveAll;
    }

    /* ---------------------------------------------------------
       Boot
       --------------------------------------------------------- */
    (async function boot() {
      const info = weekInfo(new Date());
      activeWeekKey = info.key; activeWeekLabel = info.label; previousWeekKey = info.prevKey;

      bindUI(); bindThemes(); bindPresentationMode();
      await initAuth();

      renderPodsLine();
      renderWeeksLine();
      populatePodDropdowns();

      rebindRealtime();
    })();
  </script>
</body>
</html>
