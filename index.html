<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POD Release notification system</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Base (Default/Indigo) Theme */
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --primary-bg: #4f46e5;
            --secondary-bg: #f9fafb; /* Gray-50 */
            --text-color: #1f2937; /* Gray-900 */
        }
        
        /* Dark Theme */
        .theme-dark {
            --primary-color: #10b981; /* Emerald-500 as accent */
            --primary-bg: #1f2937; /* Gray-800 */
            --secondary-bg: #374151; /* Gray-700 */
            --text-color: #f3f4f6; /* Gray-100 */
        }
        
        /* Teal Accent Theme */
        .theme-teal {
            --primary-color: #14b8a6; /* Teal-500 */
            --primary-bg: #14b8a6;
            --secondary-bg: #f0fdfa; /* Teal-50 */
            --text-color: #115e59; /* Teal-900; */
        }

        /* Ocean Blue Theme */
        .theme-blue {
            --primary-color: #3b82f6; /* Blue-500 */
            --primary-bg: #3b82f6;
            --secondary-bg: #eff6ff; /* Blue-50 */
            --text-color: #1e3a8a; /* Blue-900 */
        }

        /* Rose Theme */
        .theme-pink {
            --primary-color: #ec4899; /* Pink-500 */
            --primary-bg: #ec4899;
            --secondary-bg: #fdf2f8; /* Pink-50 */
            --text-color: #831843; /* Pink-900 */
        }

        /* Forest Green Theme */
        .theme-emerald {
            --primary-color: #059669; /* Emerald-600 */
            --primary-bg: #059669;
            --secondary-bg: #f0fdfa; /* Emerald-50 */
            --text-color: #064e3b; /* Emerald-900 */
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--secondary-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Apply theme colors using variables */
        .header-bg { background-color: var(--primary-bg); }
        .header-text { color: var(--text-color); }
        .main-button { background-color: var(--primary-color); }
        /* Adjusted hover for better contrast calculation */
        .main-button:hover { background-color: color-mix(in srgb, var(--primary-color) 85%, black); } 
        .border-primary { border-color: color-mix(in srgb, var(--primary-color) 20%, white); }
        .text-primary { color: var(--primary-color); }
        .focus-primary { 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 1px var(--primary-color);
        }
        
        /* Card background in non-dark themes */
        .bg-white { 
            background-color: var(--secondary-bg); /* Use secondary background for card/white areas */
        }
        .theme-dark .bg-white {
            background-color: #1f2937; /* Dark mode card bg */
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        #week-selector-container::-webkit-scrollbar { height: 6px; }
        #week-selector-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        #week-selector-container::-webkit-scrollbar-track { background: #f1f5f9; }

        /* Presentation Mode Hiding */
        body.presentation-mode .no-clutter,
        body.presentation-mode .edit-icon,
        body.presentation-mode .controls,
        body.presentation-mode .footer-controls,
        /* NEW: Hide PDF button in presentation mode */
        body.presentation-mode #pdf-download-btn,
        body.presentation-mode #confirmation-modal { 
            display: none !important;
        }
        /* Ensure the main grid takes full width in presentation mode */
        body.presentation-mode #dashboard-grid {
             grid-template-columns: 1fr !important;
        }

        /* Styling for Print (PDF) Output */
        @media print {
            body { background-color: white !important; color: black !important; }
            .no-print { display: none !important; }
            .main-content-grid {
                grid-template-columns: 2fr 1fr; 
            }
            header, footer, .controls { border: none !important; }
            #pdf-download-btn { display: none !important; } /* Hide for actual printing */
            /* Ensure modal content is hidden in print */
            #item-modal, #theme-modal, #settings-modal, #confirmation-modal {
                display: none !important;
            }
        }
    </style>
    <!-- Lucide icons for professional look (e.g., edit, trash) -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50">

    <div id="app" class="min-h-screen p-4 sm:p-6 relative">
        <!-- Presentation Mode Toggle (Top Right) -->
        <button 
            id="presentation-toggle-btn" 
            class="no-clutter absolute top-6 right-6 z-40 p-2 text-primary bg-white rounded-full shadow-lg hover:shadow-xl transition duration-300" 
            title="Toggle Presentation Mode (Press Esc to exit)"
            onclick="togglePresentationMode()"
        >
            <i data-lucide="monitor" class="w-6 h-6"></i>
        </button>

        <!-- Header & Customization (Now fixed) -->
        <header class="mb-6 pb-4 border-b-2 border-primary flex flex-col justify-between items-start transition duration-300">
            <!-- Fixed Header -->
            <h1 class="text-3xl font-extrabold text-primary p-1 w-full">
                POD Release Notification System
            </h1>
            
            <div class="mt-4 w-full flex justify-between items-center text-sm text-gray-600 no-clutter no-print">
                <div class="flex items-center space-x-2">
                    <span class="font-medium text-gray-700">Filter by Pod:</span>
                    <!-- Pod Filter List -->
                    <div id="pod-filter-list" class="flex flex-wrap space-x-3">
                        <!-- Pod buttons generated here -->
                    </div>
                </div>
            </div>
        </header>

        <!-- Timeline / Week Selector -->
        <div class="controls mb-6 p-4 bg-white rounded-xl shadow-lg no-clutter no-print">
            <h3 class="text-base font-semibold text-gray-700 mb-3">Release Timeline (Current Focus: <span id="current-week-display" class="font-bold text-primary"></span>)</h3>
            <div id="week-selector-container" class="flex overflow-x-auto space-x-2 pb-2">
                <!-- Week buttons generated here -->
            </div>
        </div>
        
        <!-- Controls & New Item Button (Kept for general "Add New Item") -->
        <div class="controls flex justify-end items-center mb-6 p-4 bg-white rounded-xl shadow-lg no-clutter no-print">
            <!-- New Item Button -->
            <button 
                id="new-item-btn"
                class="px-4 py-2 main-button text-white font-semibold rounded-lg shadow-lg transition duration-300 whitespace-nowrap w-full sm:w-auto"
                onclick="window.openModal(true, 'Next Week')"
            >
                + Add General Release Item
            </button>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center p-8 hidden">
            <svg class="animate-spin h-8 w-8 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-600">Connecting to database...</p>
        </div>


        <!-- Dashboard Grid (2-Column Layout) -->
        <div id="dashboard-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-6 auto-rows-fr main-content-grid">
            
            <!-- Left Column (Stack Previous and Next Releases) -->
            <div class="lg:col-span-2 space-y-6">
                <div id="previous-releases">
                    <!-- Previous Week Card will be injected here -->
                </div>
                <div id="next-releases">
                    <!-- Next Week Card will be injected here -->
                </div>
            </div>

            <!-- Right Column (Blockers) -->
            <div id="blockers-section" class="lg:col-span-1">
                <!-- Blockers Card will be injected here -->
            </div>

        </div>

        <!-- Footer -->
        <footer class="mt-8 text-sm text-gray-500 pt-4 border-t border-gray-300 flex justify-between items-center">
            <!-- Control Buttons (Bottom Left) -->
            <div class="footer-controls flex items-center space-x-4">
                <!-- Theme Option Button -->
                <button 
                    id="theme-toggle-btn" 
                    class="p-2 text-gray-500 bg-white rounded-full shadow-md hover:bg-gray-100 transition duration-300" 
                    title="Change Theme"
                    onclick="window.openThemeModal()"
                >
                    <i data-lucide="palette" class="w-5 h-5"></i>
                </button>
                
                <!-- Admin Settings Button -->
                <button 
                    id="admin-settings-btn" 
                    class="p-2 text-gray-500 bg-white rounded-full shadow-md hover:bg-gray-100 transition duration-300" 
                    title="Admin Settings (Pods, Categories)"
                    onclick="window.openSettingsModal()"
                >
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <span>Data Source: Firebase Firestore | User: <span id="user-id-display">...</span></span>
            </div>

            <!-- PDF Download Button (Bottom Right) -->
            <button id="pdf-download-btn" class="px-3 py-1 bg-gray-200 text-gray-700 font-medium rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 no-print">
                Download as PDF
            </button>
        </footer>
    </div>

    <!-- Modal for adding/editing item -->
    <div id="item-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 transition-transform duration-300 transform scale-95 opacity-0" id="modal-content">
            <div class="flex justify-between items-center p-5 border-b bg-primary rounded-t-xl header-bg">
                <h3 id="modal-title" class="text-2xl font-semibold text-white">Add New Release Item</h3>
                <button id="close-modal-btn" class="text-white hover:text-gray-200 text-3xl font-light">&times;</button>
            </div>
            <form id="item-form" class="p-6 space-y-4">
                <input type="hidden" id="item-id-input" name="id" value="" />
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="key-input" class="block text-sm font-medium text-gray-700">Ticket Key (e.g., PAY-123)</label>
                        <input type="text" id="key-input" name="key" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border focus-primary"
                        />
                    </div>
                    <div>
                        <label for="owner-input" class="block text-sm font-medium text-gray-700">Owner</label>
                        <input type="text" id="owner-input" name="owner" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border focus-primary"
                        />
                    </div>
                </div>

                <div>
                    <label for="summary-input" class="block text-sm font-medium text-gray-700">Summary / Description</label>
                    <textarea id="summary-input" name="summary" rows="2" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border focus-primary"
                    ></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 sm:grid-cols-4">
                    <label-select id="pod-select-form" label="Pod" name="pod"></label-select>
                    <label-select id="priority-select-form" label="Priority" name="priority"></label-select>
                    <label-select id="category-select-form" label="Category" name="week_type"></label-select>
                    <label-select id="status-select-form" label="Status" name="status"></label-select>
                </div>
                
                <div>
                    <label for="week-input" class="block text-sm font-medium text-gray-700">Target Week (e.g., W52_2025)</label>
                    <input type="text" id="week-input" name="week_id" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border focus-primary"
                        title="Format: W[WeekNumber]_[Year], e.g., W52_2025"
                    />
                </div>


                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="form-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 shadow-md">
                        Cancel
                    </button>
                    <button type="submit" id="form-submit-btn" class="px-4 py-2 text-sm font-medium text-white main-button rounded-lg transition duration-150 shadow-md">
                        Save Item
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for Theme Selection -->
    <div id="theme-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 p-6 transition-transform duration-300 transform scale-95 opacity-0" id="theme-modal-content">
            <h3 class="text-xl font-semibold text-gray-900 mb-4 border-b pb-2">Select Theme</h3>
            <div id="theme-options" class="grid grid-cols-3 gap-4">
                <!-- Theme buttons will be rendered here -->
            </div>
            <button id="close-theme-modal-btn" class="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-2xl font-light">&times;</button>
        </div>
    </div>

    <!-- Admin Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-xl mx-4 transition-transform duration-300 transform scale-95 opacity-0" id="settings-modal-content">
            <div class="flex justify-between items-center p-5 border-b bg-primary rounded-t-xl header-bg">
                <h3 class="text-2xl font-semibold text-white">Admin Settings</h3>
                <button id="close-settings-modal-btn" class="text-white hover:text-gray-200 text-3xl font-light">&times;</button>
            </div>
            <form id="settings-form" class="p-6 space-y-6">
                <!-- Pods Editor -->
                <div>
                    <label for="pods-input" class="block text-sm font-bold text-gray-700 mb-2">Editable Pod List (One item per line):</label>
                    <textarea id="pods-input" rows="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border focus-primary" placeholder="Enter one pod name per line."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Example: Demand and supply, SLA, Loss reduction...</p>
                </div>
                
                <!-- Week Types Editor -->
                <div>
                    <label for="week-types-input" class="block text-sm font-bold text-gray-700 mb-2">Editable Category Options (One item per line):</label>
                    <textarea id="week-types-input" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border focus-primary" placeholder="Enter one category per line."></textarea>
                    <p class="text-xs text-gray-500 mt-1">These populate the 'Category' dropdown when adding items. Fixed options (Next Week, Previous Week, Blocker) are always included.</p>
                </div>
                
                <!-- Custom Weeks Editor -->
                <div>
                    <label for="custom-weeks-input" class="block text-sm font-bold text-gray-700 mb-2">Editable Timeline Weeks (W##_YYYY format, one per line):</label>
                    <textarea id="custom-weeks-input" rows="6" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-3 border focus-primary" placeholder="Example: W52_2025, W01_2026, W02_2026"></textarea>
                    <p class="text-xs text-gray-500 mt-1">These weeks are displayed in the timeline selector at the top.</p>
                </div>

                <div class="pt-4 flex justify-end">
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white main-button rounded-lg transition duration-150 shadow-md">
                        Save Settings
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Enable debug logging for Firestore
        setLogLevel('Debug');

        // --- Global Configuration (Using environment variables) ---
        // These variables are injected by the Canvas environment, ensuring secure access to your project.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'anonymous'; 
        let dashboardData = []; 
        let currentFilter = 'All'; 
        let currentWeekId = ''; 
        let currentTheme = 'default';
        let isAuthReady = false;

        // --- Application Constants (Now loaded from Firestore) ---
        let PODS = ['Demand and supply', 'SLA', 'Loss reduction', 'Customer Experience', 'High yield client'];
        const PRIORITY_OPTIONS = ['Critical', 'High', 'Medium', 'Low'];
        const STATUS_OPTIONS = ['Planned', 'In Progress', 'Released', 'Blocked'];
        // Fixed keys for UI sections - MUST NOT be changed even if custom options are changed
        const NEXT_WEEK_KEY = 'Next Week'; 
        const PREV_WEEK_KEY = 'Previous Week'; 
        const BLOCKER_KEY = 'Blocker'; 
        let WEEK_TYPE_OPTIONS = [NEXT_WEEK_KEY, PREV_WEEK_KEY, BLOCKER_KEY]; // Default options for the form
        let CUSTOM_WEEKS = []; 
        
        // --- Firestore Collection Paths (Public data) ---
        // Path: /artifacts/{appId}/public/data/releases
        const COLLECTION_RELEASES = 'releases'; 
        // Path: /artifacts/{appId}/public/data/settings
        const COLLECTION_SETTINGS = 'settings'; 
        const SETTINGS_DOC_ID = 'app_config';
        
        const THEMES = [
            { id: 'default', name: 'Indigo', class: '', primary: '#4f46e5' }, 
            { id: 'dark', name: 'Dark Mode', class: 'theme-dark', primary: '#1f2937' }, 
            { id: 'teal', name: 'Teal Accent', class: 'theme-teal', primary: '#14b8a6' }, 
            { id: 'blue', name: 'Ocean Blue', class: 'theme-blue', primary: '#3b82f6' }, 
            { id: 'pink', name: 'Rose', class: 'theme-pink', primary: '#ec4899' }, 
            { id: 'emerald', name: 'Forest Green', class: 'theme-emerald', primary: '#059669' }, 
        ];


        // --- DOM Elements ---
        const body = document.body;
        const userIdDisplay = document.getElementById('user-id-display');
        const podFilterList = document.getElementById('pod-filter-list');
        const weekSelectorContainer = document.getElementById('week-selector-container');
        const currentWeekDisplay = document.getElementById('current-week-display');
        const newItemBtn = document.getElementById('new-item-btn');
        const itemModal = document.getElementById('item-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const formCancelBtn = document.getElementById('form-cancel-btn');
        const itemForm = document.getElementById('item-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const previousReleasesDiv = document.getElementById('previous-releases');
        const nextReleasesDiv = document.getElementById('next-releases');
        const blockersSectionDiv = document.getElementById('blockers-section');
        const themeModal = document.getElementById('theme-modal');
        const themeModalContent = document.getElementById('theme-modal-content');
        const closeThemeModalBtn = document.getElementById('close-theme-modal-btn');
        const themeOptionsDiv = document.getElementById('theme-options');
        const pdfDownloadBtn = document.getElementById('pdf-download-btn');
        
        // Admin Settings Elements
        const settingsModal = document.getElementById('settings-modal');
        const settingsModalContent = document.getElementById('settings-modal-content');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
        const settingsForm = document.getElementById('settings-form');
        const podsInput = document.getElementById('pods-input');
        const weekTypesInput = document.getElementById('week-types-input');
        const customWeeksInput = document.getElementById('custom-weeks-input'); 


        // --- Custom Component for Select Inputs ---

        class LabelSelect extends HTMLElement {
            constructor() {
                super();
                this.innerHTML = `
                    <div>
                        <label for="${this.id}" class="block text-sm font-medium text-gray-700">${this.getAttribute('label')}</label>
                        <select id="${this.id}-select" name="${this.getAttribute('name')}" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border focus-primary"
                        ></select>
                    </div>
                `;
            }
            // Ensure the select element ID is correct for use in forms
            get selectElement() {
                return this.querySelector('select');
            }
        }
        customElements.define('label-select', LabelSelect);

        // --- Utility Functions ---

        const getPriorityColor = (priority) => {
            switch (priority) {
                case 'Critical': return 'bg-red-600';
                case 'High': return 'bg-orange-500';
                case 'Medium': return 'bg-yellow-500';
                case 'Low': return 'bg-green-500';
                default: return 'bg-gray-400';
            }
        };

        const createPriorityBadge = (priority) => `
            <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-medium text-white ${getPriorityColor(priority)}">
                ${priority}
            </span>
        `;
        
        const populateSelect = (id, options) => {
            const selectElement = document.getElementById(id)?.selectElement;
            if (!selectElement) return;
            selectElement.innerHTML = '';
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });
            // Select the first option if none is selected
            if (options.length > 0 && selectElement.value === "") {
                selectElement.value = options[0];
            }
        };

        const weekToLabel = (weekId) => {
            if (!weekId || !weekId.startsWith('W')) return 'N/A';
            const [w, y] = weekId.slice(1).split('_');
            const weekNumber = parseInt(w, 10);
            const year = y.slice(2);
            
            let quarterLabel = '';
            if (weekNumber >= 40) quarterLabel = 'Q4';
            else if (weekNumber >= 26) quarterLabel = 'Q3';
            else if (weekNumber >= 13) quarterLabel = 'Q2';
            else quarterLabel = 'Q1';

            return `W${w} (${quarterLabel}'${year})`;
        };
        
        /**
         * Calculates the week ID immediately preceding the given week ID (Wxx_YYYY).
         */
        const getPreviousWeekId = (currentWeekId) => {
            if (!currentWeekId || !currentWeekId.startsWith('W')) return null;

            const [wStr, yStr] = currentWeekId.slice(1).split('_');
            let week = parseInt(wStr, 10);
            let year = parseInt(yStr, 10);

            if (week === 1) {
                week = 52;
                year -= 1;
            } else {
                week -= 1;
            }
            
            // Re-format to W##_YYYY
            return `W${String(week).padStart(2, '0')}_${year}`;
        };


        const getCurrentWeekId = () => {
            // Calculate a plausible current week ID (e.g., W52_2026) for consistent demo purposes
            const now = new Date();
            const year = now.getFullYear();
            // Simple approximation: Week number is (Day of Year / 7)
            const onejan = new Date(year, 0, 1);
            const weekNum = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            const formattedWeekNum = String(weekNum).padStart(2, '0');
            return `W${formattedWeekNum}_${year}`;
        };

        const getCustomWeeksDefault = () => {
            const current = getCurrentWeekId();
            const [w, y] = current.slice(1).split('_').map(Number);
            const defaultWeeks = [];
            
            // Generate previous 2 weeks and next 3 weeks
            for (let i = -2; i <= 3; i++) {
                let targetWeek = w + i;
                let targetYear = y;

                // Simple wrap-around logic (not perfectly ISO week calendar accurate, but functional)
                if (targetWeek <= 0) {
                    targetWeek += 52;
                    targetYear -= 1;
                } else if (targetWeek > 52) {
                    targetWeek -= 52;
                    targetYear += 1;
                }

                if (targetYear >= y - 1 && targetYear <= y + 1) { // Limit range
                    defaultWeeks.push(`W${String(targetWeek).padStart(2, '0')}_${targetYear}`);
                }
            }
            // Sort them to ensure correct order
            defaultWeeks.sort((a, b) => {
                const [wA, yA] = a.slice(1).split('_').map(Number);
                const [wB, yB] = b.slice(1).split('_').map(Number);
                if (yA !== yB) return yA - yB;
                return wA - wB;
            });
            return [...new Set(defaultWeeks)]; // Ensure uniqueness
        }
        
        // --- THEME LOGIC ---
        
        // Expose to window for inline HTML access
        window.changeTheme = async (themeId) => {
            const theme = THEMES.find(t => t.id === themeId);
            if (!theme) return;

            // 1. Update global state
            currentTheme = theme.id;
            
            // 2. Apply CSS class to body
            body.className = body.className.split(' ').filter(c => !c.startsWith('theme-') && c !== 'bg-gray-50').join(' ');
            if (theme.class) {
                body.classList.add(theme.class);
            } else {
                body.classList.add('bg-gray-50'); 
            }
            
            // 3. Persist to Firestore (if DB is ready)
            try {
                if (db && isAuthReady) {
                    // Use setDoc with merge true to update only the theme field
                    await setDoc(settingsRef(), { theme: themeId, updatedBy: userId, updatedTimestamp: new Date().toISOString() }, { merge: true });
                }
            } catch (error) {
                console.error('Error persisting theme:', error);
            }
            
            renderPodFilters(); 
            lucide.createIcons();
        };

        window.openThemeModal = () => { // Expose to window for inline HTML access
            renderThemeOptions();
            themeModal.classList.remove('hidden');
            setTimeout(() => {
                themeModalContent.classList.remove('scale-95', 'opacity-0');
                themeModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeThemeModal = () => { // Expose to window for inline HTML access
            themeModalContent.classList.remove('scale-100', 'opacity-100');
            themeModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                themeModal.classList.add('hidden');
            }, 300);
        };

        const renderThemeOptions = () => {
            themeOptionsDiv.innerHTML = THEMES.map(theme => {
                const isActive = theme.id === currentTheme;
                // Use a dynamic contrast color for the text inside the button preview
                const textColor = theme.id === 'dark' || theme.id === 'default' ? 'text-white' : 'text-gray-800'; 
                
                return `
                    <button 
                        class="theme-option p-3 rounded-lg shadow-md border-2 transition duration-200 flex flex-col items-center hover:shadow-lg ${isActive ? 'border-primary ring-2 ring-primary' : 'border-gray-200'}"
                        style="background-color: ${theme.primary};"
                        onclick="window.changeTheme('${theme.id}'); window.closeThemeModal();"
                    >
                        <i data-lucide="droplet" class="w-6 h-6 ${textColor} mb-1"></i>
                        <span class="text-xs font-semibold ${textColor}">${theme.name.split(' ')[0]}</span>
                    </button>
                `;
            }).join('');
            lucide.createIcons();
        };

        closeThemeModalBtn.addEventListener('click', window.closeThemeModal);
        
        // --- PRESENTATION MODE LOGIC ---
        
        window.togglePresentationMode = () => {
            body.classList.toggle('presentation-mode');
            
            const toggleButton = document.getElementById('presentation-toggle-btn');
            const icon = toggleButton ? toggleButton.querySelector('i') : null;
            
            if (icon) {
                if (body.classList.contains('presentation-mode')) {
                    icon.setAttribute('data-lucide', 'monitor-off');
                } else {
                    icon.setAttribute('data-lucide', 'monitor');
                }
                lucide.createIcons();
            } else {
                console.warn('Presentation toggle icon not found after toggling mode.');
            }
            
            renderPodFilters(); 
        };

        // Event Listener for ESC key to exit presentation mode and close modals
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (body.classList.contains('presentation-mode')) {
                    window.togglePresentationMode();
                }
                if (!itemModal.classList.contains('hidden')) window.closeModal();
                if (!themeModal.classList.contains('hidden')) window.closeThemeModal();
                if (!settingsModal.classList.contains('hidden')) window.closeSettingsModal();
            }
        });
        
        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        
        const initFirebaseAndAuth = async () => {
            loadingIndicator.classList.remove('hidden');
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with custom token if available, otherwise anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                userIdDisplay.textContent = userId;
                isAuthReady = true;

                // Start listeners
                loadSettings();
                listenForReleases();

            } catch (error) {
                console.error("Firebase/Auth initialization failed:", error);
                userIdDisplay.textContent = 'ERROR (Check Console)';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

        // --- FIREBASE REFERENCES ---
        // Public settings reference: /artifacts/{appId}/public/data/settings/app_config
        const settingsRef = () => doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_SETTINGS, SETTINGS_DOC_ID);
        // Public releases collection reference: /artifacts/{appId}/public/data/releases
        const releasesCollection = () => collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_RELEASES);
        const releaseDocRef = (id) => doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_RELEASES, id);


        // --- SETTINGS MANAGEMENT (Admin Configuration) ---
        
        const loadSettings = async () => {
            if (!isAuthReady || !db) return;

            try {
                // Real-time listener for app settings
                onSnapshot(settingsRef(), (docSnapshot) => {
                    const settings = docSnapshot.data() || {};
                    
                    // 1. Update Pods
                    PODS = settings.pods && Array.isArray(settings.pods) && settings.pods.length > 0
                        ? settings.pods
                        : ['Demand and supply', 'SLA', 'Loss reduction', 'Customer Experience', 'High yield client'];
                    
                    // 2. Update Week Types (Categories for form)
                    WEEK_TYPE_OPTIONS = [NEXT_WEEK_KEY, PREV_WEEK_KEY, BLOCKER_KEY]; // Reset fixed keys
                    if (settings.weekTypes && Array.isArray(settings.weekTypes) && settings.weekTypes.length > 0) {
                        settings.weekTypes.forEach(wt => {
                            if (!WEEK_TYPE_OPTIONS.includes(wt)) {
                                WEEK_TYPE_OPTIONS.push(wt);
                            }
                        });
                    }

                    // 3. Update Custom Weeks (Timeline selector)
                    CUSTOM_WEEKS = settings.customWeeks && Array.isArray(settings.customWeeks) && settings.customWeeks.length > 0
                        ? settings.customWeeks
                        : getCustomWeeksDefault();
                    
                    // 4. Update Theme
                    const loadedTheme = settings.theme || 'default';
                    if (loadedTheme !== currentTheme) {
                        window.changeTheme(loadedTheme); // Apply theme (and handle persistence update prevention within changeTheme)
                    } else {
                        // Re-render UI based on new settings (Pod filters might need updating regardless)
                        renderFormSelects();
                        renderPodFilters();
                        renderWeekSelector();
                    }

                }, (error) => {
                    console.error("Error listening to settings:", error);
                });
            } catch (error) {
                console.error("Error setting up settings listener:", error);
            }
        };

        // Function to save admin settings (Pods, Week Types, Custom Weeks)
        window.saveSettings = async (event) => {
            event.preventDefault();
            
            if (!isAuthReady || !db) {
                console.error("Database not ready. Cannot save settings.");
                return;
            }

            // Parse text area inputs
            const newPods = podsInput.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            const newWeekTypes = weekTypesInput.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            
            // Filter custom weeks for correct format: W##_YYYY
            const newCustomWeeks = customWeeksInput.value.split('\n').map(s => s.trim()).filter(s => s.length > 0 && s.match(/^W\d{2}_\d{4}$/));

            try {
                // Use setDoc to update the single settings document
                await setDoc(settingsRef(), {
                    pods: newPods,
                    weekTypes: newWeekTypes,
                    customWeeks: newCustomWeeks,
                    theme: currentTheme, // Keep current theme
                    updatedBy: userId,
                    updatedTimestamp: new Date().toISOString()
                }, { merge: true });

                console.log("Settings saved successfully.");
                window.closeSettingsModal();
            } catch (error) {
                console.error("Error saving settings:", error);
            }
        };

        // --- DATA MANAGEMENT (Releases) ---
        
        const listenForReleases = () => {
            if (!isAuthReady || !db) return;

            // Real-time listener for the releases collection
            onSnapshot(releasesCollection(), (snapshot) => {
                // Map documents to include the document ID
                dashboardData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`Loaded ${dashboardData.length} release items.`);
                // Re-render dashboard on any data change
                renderDashboard();
            }, (error) => {
                console.error("Error listening to releases:", error);
            });
        };

        // Function to save/update a release item (CRUD Create/Update)
        window.saveReleaseItem = async (event) => {
            event.preventDefault();
            if (!isAuthReady || !db) return;

            const form = event.target;
            const data = {
                key: form['key'].value.trim(),
                owner: form['owner'].value.trim(),
                summary: form['summary'].value.trim(),
                pod: form['pod'].value,
                priority: form['priority'].value,
                status: form['status'].value,
                week_type: form['week_type'].value,
                week_id: form['week_id'].value.trim(),
                updatedBy: userId,
                updatedTimestamp: new Date().toISOString()
            };
            
            const itemId = form['id'].value;

            try {
                if (itemId) {
                    // Update existing item using updateDoc
                    await updateDoc(releaseDocRef(itemId), data);
                    console.log("Item updated:", itemId);
                } else {
                    // Add new item using addDoc
                    await addDoc(releasesCollection(), { 
                        ...data,
                        createdBy: userId,
                        createdTimestamp: new Date().toISOString()
                    });
                    console.log("New item added.");
                }
                window.closeModal();
            } catch (error) {
                console.error("Error saving release item:", error);
            }
        };

        // Function to delete a release item (CRUD Delete)
        window.deleteReleaseItem = async (itemId) => {
             if (!isAuthReady || !db) return;

             // Use the custom confirmation modal (replaces alert/confirm)
             const confirmDelete = await showCustomConfirmation(
                "Confirm Delete",
                "Are you sure you want to permanently delete this release item? This action cannot be undone."
             );
             
             if (!confirmDelete) return;

             try {
                await deleteDoc(releaseDocRef(itemId));
                console.log("Item deleted:", itemId);
             } catch (error) {
                console.error("Error deleting release item:", error);
             }
        };


        // --- UI RENDERING ---

        const renderFormSelects = () => {
            // Populate form selects (used in item modal)
            populateSelect('pod-select-form', PODS);
            populateSelect('priority-select-form', PRIORITY_OPTIONS);
            populateSelect('category-select-form', WEEK_TYPE_OPTIONS);
            populateSelect('status-select-form', STATUS_OPTIONS);
        };

        window.setPodFilter = (pod) => {
            currentFilter = pod;
            renderPodFilters(); // Re-render to highlight active filter
            renderDashboard(); // Re-render dashboard content
        };

        const renderPodFilters = () => {
            const allPods = ['All', ...PODS];
            podFilterList.innerHTML = allPods.map(pod => {
                const isActive = pod === currentFilter;
                return `
                    <button 
                        class="px-3 py-1 text-xs font-semibold rounded-full transition duration-150 whitespace-nowrap
                        ${isActive 
                            ? 'text-white main-button shadow-md' 
                            : 'text-gray-600 bg-gray-200 hover:bg-gray-300'
                        }"
                        onclick="window.setPodFilter('${pod}')"
                    >
                        ${pod}
                    </button>
                `;
            }).join('');
        };
        
        window.setCurrentWeek = (weekId) => {
            currentWeekId = weekId;
            currentWeekDisplay.textContent = weekToLabel(weekId);
            renderWeekSelector(); // Re-render to highlight active week
            renderDashboard(); // Re-render dashboard content
        };

        const renderWeekSelector = () => {
            weekSelectorContainer.innerHTML = CUSTOM_WEEKS.map(weekId => {
                const isActive = weekId === currentWeekId;
                const weekLabel = weekToLabel(weekId);
                const isCurrent = weekId === getCurrentWeekId();
                
                return `
                    <button
                        class="px-4 py-2 text-sm font-medium rounded-lg shadow-sm transition duration-150 flex-shrink-0 whitespace-nowrap
                        ${isActive 
                            ? 'text-white main-button shadow-xl ring-2 ring-primary ring-opacity-50' 
                            : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-200'
                        }"
                        onclick="window.setCurrentWeek('${weekId}')"
                    >
                        ${weekLabel} ${isCurrent ? '<span class="text-xs ml-1">(Current)</span>' : ''}
                    </button>
                `;
            }).join('');

             // If no week is selected, set the current one as default after rendering
            if (!currentWeekId && CUSTOM_WEEKS.length > 0) {
                 window.setCurrentWeek(getCurrentWeekId());
             }
        };

        const renderReleaseItem = (item) => {
            const priorityBadge = createPriorityBadge(item.priority);
            
            return `
                <div class="p-4 bg-white rounded-lg shadow-md border-l-4 border-primary hover:shadow-lg transition duration-200 mb-3 flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-3 mb-1">
                            <h4 class="text-base font-semibold text-gray-800 truncate">${item.key} - ${item.summary}</h4>
                            ${priorityBadge}
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-600">${item.pod}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2 truncate">Owner: ${item.owner} | Status: ${item.status}</p>
                        <div class="text-xs text-gray-500 flex items-center space-x-2">
                             <span>Week: ${item.week_id ? weekToLabel(item.week_id) : 'N/A'}</span>
                             <span>| Category: ${item.week_type}</span>
                        </div>
                    </div>
                    <!-- Actions -->
                    <div class="no-clutter flex items-center space-x-2 ml-4 flex-shrink-0">
                        <button class="edit-icon text-gray-500 hover:text-primary transition" title="Edit Item" onclick="window.openModal(false, null, '${item.id}')">
                            <i data-lucide="square-pen" class="w-5 h-5"></i>
                        </button>
                        <button class="edit-icon text-gray-500 hover:text-red-500 transition" title="Delete Item" onclick="window.deleteReleaseItem('${item.id}')">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `;
        };

        const renderReleaseCard = (title, items) => {
            return `
                <div class="release-card bg-white p-6 rounded-xl shadow-2xl border-t-4 border-primary">
                    <h2 class="text-xl font-extrabold text-primary mb-4 border-b pb-2">${title} (${items.length})</h2>
                    <div class="space-y-4 min-h-[100px]" id="release-list-${title.replace(/\s/g, '-')}">
                        ${items.length === 0 
                            ? `<p class="text-gray-500 italic p-4 bg-gray-50 rounded-lg">No ${title.toLowerCase()} items found for the current filters.</p>` 
                            : items.map(renderReleaseItem).join('')
                        }
                    </div>
                </div>
            `;
        };

        const renderDashboard = () => {
            if (!isAuthReady || !currentWeekId) return;

            // 1. Filter by Pod (if not 'All')
            const filteredData = currentFilter === 'All'
                ? dashboardData
                : dashboardData.filter(item => item.pod === currentFilter);

            // 2. Determine previous and next week IDs dynamically
            const prevWeekId = getPreviousWeekId(currentWeekId);
            const nextWeekId = currentWeekId; // Current focus week is treated as the 'Next' or 'Current' release

            // 3. Separate into sections based on week_type and week_id
            const previousReleases = filteredData.filter(item => 
                (item.week_type === PREV_WEEK_KEY || item.week_id === prevWeekId) && item.week_type !== BLOCKER_KEY
            );
            const nextReleases = filteredData.filter(item => 
                (item.week_type === NEXT_WEEK_KEY || item.week_id === nextWeekId) && item.week_type !== BLOCKER_KEY
            );
            const blockers = filteredData.filter(item => 
                item.week_type === BLOCKER_KEY
            );
            
            // Sort by priority for better visibility (Critical first)
            const sortOrder = PRIORITY_OPTIONS;
            const sortByPriority = (a, b) => sortOrder.indexOf(a.priority) - sortOrder.indexOf(b.priority);

            previousReleasesDiv.innerHTML = renderReleaseCard(`Previous Release Items (${prevWeekId ? weekToLabel(prevWeekId) : 'N/A'})`, previousReleases.sort(sortByPriority));
            nextReleasesDiv.innerHTML = renderReleaseCard(`Current Release Items (${weekToLabel(nextWeekId)})`, nextReleases.sort(sortByPriority));
            blockersSectionDiv.innerHTML = renderReleaseCard(`Critical Blockers`, blockers.sort(sortByPriority));

            lucide.createIcons();
        };


        // --- MODAL LOGIC (CRUD Form) ---

        const resetForm = () => {
            itemForm.reset();
            document.getElementById('item-id-input').value = '';
            document.getElementById('modal-title').textContent = 'Add New Release Item';
            document.getElementById('form-submit-btn').textContent = 'Save Item';
        };

        window.openModal = (isNew, defaultCategory = null, itemId = null) => {
            resetForm();
            
            // Set default week ID (current focus week)
            document.getElementById('week-input').value = currentWeekId || getCurrentWeekId();
            
            // Set default category for new items
            const categorySelect = document.getElementById('category-select-form').selectElement;
            if (isNew && defaultCategory && categorySelect) {
                 categorySelect.value = defaultCategory;
            }

            if (itemId) {
                const item = dashboardData.find(d => d.id === itemId);
                if (item) {
                    document.getElementById('modal-title').textContent = 'Edit Release Item';
                    document.getElementById('form-submit-btn').textContent = 'Update Item';
                    document.getElementById('item-id-input').value = item.id;
                    document.getElementById('key-input').value = item.key;
                    document.getElementById('owner-input').value = item.owner;
                    document.getElementById('summary-input').value = item.summary;
                    document.getElementById('week-input').value = item.week_id;
                    
                    document.getElementById('pod-select-form').selectElement.value = item.pod;
                    document.getElementById('priority-select-form').selectElement.value = item.priority;
                    document.getElementById('category-select-form').selectElement.value = item.week_type;
                    document.getElementById('status-select-form').selectElement.value = item.status;
                }
            }

            itemModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeModal = () => {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                itemModal.classList.add('hidden');
                resetForm();
            }, 300);
        };
        
        // Custom confirmation modal (to replace confirm() browser calls)
        const showCustomConfirmation = (title, message) => {
            return new Promise(resolve => {
                const modalId = 'confirmation-modal';
                let modal = document.getElementById(modalId);
                
                // If modal doesn't exist, create it once
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = modalId;
                    // z-index 60 is higher than other modals (z-50)
                    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-[60] flex items-center justify-center hidden';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 p-6">
                            <h3 class="text-xl font-semibold text-gray-900 mb-3 border-b pb-2" id="confirm-title"></h3>
                            <p class="text-gray-700 mb-6" id="confirm-message"></p>
                            <div class="flex justify-end space-x-3">
                                <button id="confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                                <button id="confirm-ok" class="px-4 py-2 text-sm font-medium text-white main-button rounded-lg transition duration-150">Confirm</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                modal.classList.remove('hidden');

                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');

                // Listener cleanup and modal hide
                const cleanUp = () => {
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                    modal.classList.add('hidden');
                };

                const onOk = () => {
                    cleanUp();
                    resolve(true);
                };

                const onCancel = () => {
                    cleanUp();
                    resolve(false);
                };

                okBtn.addEventListener('click', onOk);
                cancelBtn.addEventListener('click', onCancel);
            });
        };


        // --- ADMIN SETTINGS MODAL LOGIC ---

        window.openSettingsModal = () => {
            if (!isAuthReady) return;

            // Load current settings into form textareas
            podsInput.value = PODS.join('\n');
            
            // Filter out the fixed keys before displaying user-editable ones
            const editableWeekTypes = WEEK_TYPE_OPTIONS.filter(wt => 
                wt !== NEXT_WEEK_KEY && wt !== PREV_WEEK_KEY && wt !== BLOCKER_KEY
            );
            weekTypesInput.value = editableWeekTypes.join('\n');
            customWeeksInput.value = CUSTOM_WEEKS.join('\n');

            settingsModal.classList.remove('hidden');
            setTimeout(() => {
                settingsModalContent.classList.remove('scale-95', 'opacity-0');
                settingsModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeSettingsModal = () => {
            settingsModalContent.classList.remove('scale-100', 'opacity-100');
            settingsModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                settingsModal.classList.add('hidden');
            }, 300);
        };

        // --- EVENT ATTACHMENTS & INITIALIZATION ---

        // Modal event listeners
        closeModalBtn.addEventListener('click', window.closeModal);
        formCancelBtn.addEventListener('click', window.closeModal);
        itemForm.addEventListener('submit', window.saveReleaseItem);

        // Settings event listeners
        closeSettingsModalBtn.addEventListener('click', window.closeSettingsModal);
        settingsForm.addEventListener('submit', window.saveSettings);

        // PDF Download Listener
        pdfDownloadBtn.addEventListener('click', () => {
            // Use presentation mode to hide controls before printing
            const originalMode = body.classList.contains('presentation-mode');
            if (!originalMode) {
                 window.togglePresentationMode();
            }

            // A small delay to ensure the DOM repaint before printing
            setTimeout(() => {
                window.print();
                // Restore presentation mode after printing
                if (!originalMode) {
                     window.togglePresentationMode();
                }
            }, 50); 
        });

        // Start the application
        initFirebaseAndAuth();

    </script>
</body>
</html>
